!function(exports){"use strict";function cType(v){return null==v?v:v.constructor||Object}function isObj(v){return v&&"object"==typeof v}function filterVoid(k){return void 0===this[k]}function getKey(obj,key){if(isObj(obj))return obj[key]}function pathKeys(path){var ct=cType(path);return ct===Array?path:ct===Number?[path]:path?path.split("/"):[]}function Trie(data){this._ks=new Map,this._fs=[],this.data=data}function getLeaf(root,keys){for(var i=0,itm=root;i<keys.length;++i)void 0!==itm&&(itm=itm._ks.get(""+keys[i]));return itm}function setLeaf(root,keys){for(var i=0,itm=root;i<keys.length;++i){var key=""+keys[i];itm._ks.has(key)||itm._ks.set(key,new Trie(getKey(itm.data,key))),itm=itm._ks.get(key)}return itm}function delLeaf(trie,keys,idx){var key=keys[idx++],kid=trie._ks.get(key);kid instanceof Trie&&(idx!==keys.length&&delLeaf(kid,keys,idx),kid._ks.size||kid._fs.length||trie._ks.delete(key))}function indexOf(arr,fcn,ctx){if(arr)for(var i=0;i<arr.length;++i)if(arr[i].f===fcn&&arr[i].c===ctx)return i;return-1}function isEqual(obj,ref){var cO=cType(obj);if(cO!==cType(ref))return!1;if(cO===Array){if(obj.length!==ref.length)return!1;for(var i=0;i<obj.length;++i)if(!isEqual(obj[i],ref[i]))return!1;return!0}if(cO===Object){var ko=Object.keys(obj);if(ko.length!==Object.keys(ref).length)return!1;for(i=0;i<ko.length;++i)if(!isEqual(obj[ko[i]],ref[ko[i]]))return!1;return!0}return obj===ref}function Store(initValue){this._ks=new Map,this._fs=[],this.data=initValue}function act(res,op){return res instanceof Error?res:setKeys(res,pathKeys(op.p),op.v,0)}function update(trie,val,key){if(val instanceof Error)return val;if(val!==trie.data){var old=trie.data;trie.data=val,trie._ks.forEach(updateKid,val);for(var i=0,fs=trie._fs;i<fs.length;++i)fs[i].f.call(fs[i].c,val,key,old)}}function updateKid(kid,k){update(kid,getKey(this,k),k)}function setKeys(obj,keys,val,idx){if(idx===keys.length)return isEqual(obj,val)?obj:val;if(!isObj(obj))return Error("invalid path: "+keys.join("/"));var k=keys[idx],o=obj[k],v=setKeys(o,keys,val,idx+1);return v instanceof Error?v:v===o?obj:Array.isArray(obj)?aSet(obj,+k,v):oSet(obj,k,v)}function aSet(arr,key,val){var tgt=arr.slice();return void 0===val?key!==arr.length-1?Error("only the last array item can be deleted"):(tgt.length=key,tgt):key<=arr.length?(tgt[key]=val,tgt):Error("invalid array index: "+key)}function oSet(obj,key,val){for(var i=0,ks=Object.keys(obj),res={};i<ks.length;++i)ks[i]!==key&&(res[ks[i]]=obj[ks[i]]);return void 0!==val&&(res[key]=val),res}Trie.prototype.on=function(key,fcn,ctx){var list=setLeaf(this,pathKeys(key))._fs;return-1===indexOf(list,fcn,ctx)&&list.push({f:fcn,c:ctx}),this},Trie.prototype.off=function(key,fcn,ctx){var keys=pathKeys(key),itm=getLeaf(this,keys),arr=itm&&itm._fs,idx=indexOf(arr,fcn,ctx);return-1!==idx&&(arr.splice(idx,1),arr.length||itm._ks.size||delLeaf(this,keys,0)),this},Trie.prototype.once=function(key,fcn,ctx){function wrap(v,k,o){store.off(key,wrap,ctx),fcn.call(this,v,k,o)}var store=this;return this.on(key,wrap,ctx)},Store.prototype.on=Trie.prototype.on,Store.prototype.off=Trie.prototype.off,Store.prototype.once=Trie.prototype.once,Store.prototype.get=function(path){for(var keys=pathKeys(path),i=0,itm=this.data;i<keys.length;++i){if(!isObj(itm))return;itm=itm[keys[i]]}return itm},Store.prototype.act=function(ops){var res=Array.isArray(ops)?ops.reduce(act,this.data):act(this.data,ops);return res instanceof Error?res:update(this,res,null)},exports.changedKeys=function(reference,value){var keys=isObj(reference)?Object.keys(reference):[],diff=[];if(isObj(value))for(var i=0;i<keys.length;++i){var key=keys[i],val=value[key];val!==reference[key]&&void 0!==val&&diff.push(key)}return diff},exports.missingKeys=function(reference,value){var keys=isObj(reference)?Object.keys(reference):[];return isObj(value)?keys.filter(filterVoid,value):keys},exports.Store=Store}(this.attostore=this.attostore||{});